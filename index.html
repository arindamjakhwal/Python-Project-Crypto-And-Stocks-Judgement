<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock/Crypto Price Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">
        <header class="bg-indigo-600 p-6">
            <h1 class="text-3xl font-bold text-white text-center">ðŸ“ˆ Stock/Crypto Price Predictor</h1>
            <p class="text-indigo-200 text-center mt-1">Powered by Linear Regression via Flask API</p>
        </header>
        
        <main class="p-6 md:p-8 space-y-8">
            
            <section class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Input Ticker</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input 
                        type="text" 
                        id="tickerInput" 
                        placeholder="e.g., AAPL, BTC-USD, TSLA" 
                        class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 text-lg uppercase"
                        value="AAPL"
                    >
                    <button 
                        id="predictButton" 
                        class="bg-indigo-600 text-white p-3 rounded-lg font-medium hover:bg-indigo-700 transition duration-150 flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Predict Price
                    </button>
                </div>
            </section>
            
            <div id="statusMessage" class="hidden p-3 rounded-lg text-sm font-medium transition duration-300"></div>

            <section id="resultsSection" class="hidden space-y-6">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    
                    <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-200 shadow-sm">
                        <p class="text-sm font-medium text-indigo-700">Last Recorded Close Price</p>
                        <p id="lastPrice" class="text-3xl font-bold text-indigo-900 mt-1">$0.00</p>
                        <p id="lastDate" class="text-xs text-indigo-500 mt-1"></p>
                    </div>

                    <div class="bg-green-50 p-5 rounded-xl border border-green-200 shadow-sm">
                        <p class="text-sm font-medium text-green-700">Predicted Next Day Close Price</p>
                        <p id="predictedPrice" class="text-3xl font-bold text-green-700 mt-1">$0.00</p>
                        <p id="predictionChange" class="text-sm font-semibold mt-1 flex items-center"></p>
                    </div>

                </div>

                <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Historical vs. Predicted Price</h3>
                    <canvas id="predictionChart" height="300"></canvas>
                </div>

                <blockquote class="text-sm text-gray-500 border-l-4 border-gray-300 pl-4 py-2 bg-gray-50 rounded-md">
                    Data is fetched in real-time by calling the Python Flask API running on **http://127.0.0.1:5000**. Ensure the backend server is running!
                </blockquote>

            </section>

        </main>
        
        <footer class="p-4 text-center text-gray-500 text-sm border-t mt-4">
            Stock Predictor Web App
        </footer>
    </div>

    <script>
        const TickerInput = document.getElementById('tickerInput');
        const PredictButton = document.getElementById('predictButton');
        const StatusMessage = document.getElementById('statusMessage');
        const ResultsSection = document.getElementById('resultsSection');
        const LastPriceElem = document.getElementById('lastPrice');
        const LastDateElem = document.getElementById('lastDate');
        const PredictedPriceElem = document.getElementById('predictedPrice');
        const PredictionChangeElem = document.getElementById('predictionChange');
        const ChartCanvas = document.getElementById('predictionChart');
        let predictionChart = null; 

        /**
         * Fetches prediction data from the Python Flask API.
         */
        async function fetchPredictionData(ticker) {
            const api_url = `http://127.0.0.1:5000/predict/${ticker}`;
            
            const response = await fetch(api_url);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `API call failed with status: ${response.status}`);
            }

            const data = await response.json();

            // Reformat API data to match frontend's rendering structure
            return {
                lastClose: data.last_close_price,
                predictedClose: data.predicted_close_price,
                lastDate: data.last_date,
                historicalData: data.historical_prices,
                labels: data.historical_dates
            };
        }

        /**
         * Renders the prediction results and chart.
         */
        function renderResults(ticker, data) {
            const lastPrice = data.lastClose;
            const predictedPrice = data.predictedClose;
            const absoluteChange = predictedPrice - lastPrice;
            const percentChange = (absoluteChange / lastPrice) * 100;

            LastPriceElem.textContent = `$${lastPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            LastDateElem.textContent = `As of ${data.lastDate}`;
            PredictedPriceElem.textContent = `$${predictedPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;

            // Update Prediction Change element
            PredictionChangeElem.textContent = `${absoluteChange >= 0 ? 'â–²' : 'â–¼'} ${absoluteChange.toFixed(2)} (${percentChange.toFixed(2)}%)`;
            
            PredictionChangeElem.classList.remove('text-red-600', 'text-green-600', 'text-gray-600');
            if (absoluteChange >= 0) {
                PredictionChangeElem.classList.add('text-green-600');
            } else {
                PredictionChangeElem.classList.add('text-red-600');
            }

            // --- Chart Rendering ---
            if (predictionChart) {
                predictionChart.destroy();
            }

            const chartLabels = [...data.labels, "Next Day"];
            
            const predictionPoints = new Array(data.historicalData.length - 1).fill(null);
            predictionPoints.push(lastPrice); // Last actual point
            predictionPoints.push(predictedPrice); // Predicted point

            predictionChart = new Chart(ChartCanvas, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Historical Price',
                            data: data.historicalData,
                            borderColor: 'rgb(59, 130, 246, 0.5)',
                            backgroundColor: 'transparent',
                            tension: 0.1,
                            pointRadius: 0,
                            borderWidth: 1.5,
                            fill: false,
                        },
                        {
                            label: 'Prediction',
                            data: predictionPoints,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'transparent',
                            tension: 0.1,
                            pointRadius: (ctx) => {
                                return ctx.dataIndex >= predictionPoints.length - 2 ? 6 : 0;
                            },
                            pointBackgroundColor: (ctx) => {
                                return ctx.dataIndex === predictionPoints.length - 1 ? 'rgb(34, 197, 94)' : 'rgb(59, 130, 246)';
                            },
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'Trading Day' },
                            ticks: {
                                callback: function(val, index) {
                                    return index % 10 === 0 || index === chartLabels.length - 1 ? this.getLabelForValue(val) : '';
                                },
                            }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'Price (USD)' },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });

            ResultsSection.classList.remove('hidden');
        }

        /**
         * Handles the main prediction process on button click.
         */
        PredictButton.addEventListener('click', async () => {
            const ticker = TickerInput.value.toUpperCase().trim();
            if (!ticker) {
                showStatus('Please enter a stock or crypto ticker!', 'bg-yellow-100 text-yellow-800');
                return;
            }

            PredictButton.disabled = true;
            ResultsSection.classList.add('hidden');
            showStatus(`Fetching and predicting price for **${ticker}**...`, 'bg-indigo-100 text-indigo-800');

            try {
                // Call the real Python API
                const predictionData = await fetchPredictionData(ticker); 

                renderResults(ticker, predictionData);
                showStatus(`Prediction complete for **${ticker}**!`, 'bg-green-100 text-green-800');

            } catch (error) {
                console.error("Prediction failed:", error);
                showStatus(`Error: ${error.message}. Ensure **app.py** is running and the ticker is valid.`, 'bg-red-100 text-red-800');
            } finally {
                PredictButton.disabled = false;
            }
        });

        /**
         * Shows a temporary status message.
         */
        function showStatus(message, className) {
            StatusMessage.innerHTML = message;
            StatusMessage.className = `p-3 rounded-lg text-sm font-medium transition duration-300 ${className}`;
            StatusMessage.classList.remove('hidden');
        }

        // Initial setup
        showStatus('Enter a ticker symbol and click "Predict Price" to begin.', 'bg-gray-100 text-gray-700');
        
    </script>
</body>
</html>